<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intent Board</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface-hover: #222632;
    --border: #2a2e3a;
    --text: #e1e4eb;
    --text-dim: #7a8194;
    --accent: #6c5ce7;
    --get: #00b894;
    --post: #0984e3;
    --put: #fdcb6e;
    --delete: #d63031;
    --patch: #e17055;
    --synced: #00b894;
    --missing: #d63031;
    --extra: #fdcb6e;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .header {
    padding: 2rem 2rem 1rem;
    max-width: 960px;
    margin: 0 auto;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
  }

  .header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .header h1 .icon {
    width: 28px;
    height: 28px;
    background: var(--accent);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .meta {
    display: flex;
    gap: 1.5rem;
    margin-top: 0.75rem;
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.25rem;
  }

  .settings-btn, .refresh-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 0.4rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.15s;
  }

  .settings-btn:hover, .refresh-btn:hover { border-color: #3a3f4f; color: var(--text); }

  .settings-panel {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 2rem;
    display: none;
  }

  .settings-panel.visible { display: block; }

  .settings-inner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    margin-bottom: 0.5rem;
  }

  .settings-inner h3 {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .setting-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .setting-row:last-child { margin-bottom: 0; }

  .setting-row label {
    font-size: 0.8rem;
    color: var(--text-dim);
    min-width: 80px;
    flex-shrink: 0;
  }

  .setting-row input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 0.4rem 0.6rem;
    color: var(--text);
    font-size: 0.8rem;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .setting-row input:focus { outline: none; border-color: var(--accent); }

  .setting-row .save-btn {
    background: var(--accent);
    border: none;
    color: #fff;
    padding: 0.4rem 0.8rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    transition: opacity 0.15s;
  }

  .setting-row .save-btn:hover { opacity: 0.85; }

  .setting-hint {
    font-size: 0.7rem;
    color: var(--text-dim);
    opacity: 0.7;
    margin-top: 0.25rem;
  }

  .saved-indicator {
    font-size: 0.7rem;
    color: var(--synced);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .saved-indicator.show { opacity: 1; }

  .source-indicator {
    max-width: 960px;
    margin: 0.5rem auto 0;
    padding: 0 2rem;
    font-size: 0.7rem;
    color: var(--text-dim);
    opacity: 0.6;
  }

  .source-indicator a { color: var(--accent); text-decoration: none; }
  .source-indicator a:hover { text-decoration: underline; }

  .sync-banner {
    max-width: 960px;
    margin: 0.75rem auto 0;
    padding: 0 2rem;
  }

  .sync-banner-inner {
    border-radius: 10px;
    padding: 0.75rem 1.25rem;
    font-size: 0.85rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sync-banner-inner.all-synced {
    background: #0d2e24;
    border: 1px solid #145c3e;
    color: var(--synced);
  }

  .sync-banner-inner.out-of-sync {
    background: #2d1b1b;
    border: 1px solid #5c2626;
    color: var(--missing);
  }

  .sync-banner-inner.loading {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .sync-banner-inner .sync-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .all-synced .sync-dot { background: var(--synced); }
  .out-of-sync .sync-dot { background: var(--missing); animation: pulse 2s infinite; }
  .loading .sync-dot { background: var(--text-dim); animation: pulse 1s infinite; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .sync-actions {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .trigger-btn {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.35rem 0.75rem;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    background: var(--accent);
    color: #fff;
  }

  .trigger-btn:hover { opacity: 0.85; }
  .trigger-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .trigger-btn.running {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .trigger-status {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .trigger-status a { color: var(--accent); text-decoration: none; }
  .trigger-status a:hover { text-decoration: underline; }

  .no-config {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .stats {
    display: flex;
    gap: 0.75rem;
    padding: 0 2rem;
    max-width: 960px;
    margin: 1rem auto;
  }

  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.85rem 1.25rem;
    flex: 1;
    text-align: center;
  }

  .stat .number { font-size: 1.75rem; font-weight: 700; line-height: 1; }

  .stat .label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.25rem;
  }

  .stat.synced .number { color: var(--synced); }
  .stat.missing .number { color: var(--missing); }
  .stat.extra .number { color: var(--extra); }

  .board {
    max-width: 960px;
    margin: 1.25rem auto;
    padding: 0 2rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: background 0.15s, border-color 0.15s;
    cursor: default;
  }

  .card:hover { background: var(--surface-hover); border-color: #3a3f4f; }
  .card.status-missing { border-left: 3px solid var(--missing); }
  .card.status-synced { border-left: 3px solid var(--synced); }
  .card.status-extra { border-left: 3px solid var(--extra); }

  .method-badge {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 0.3rem 0.6rem;
    border-radius: 5px;
    min-width: 58px;
    text-align: center;
    flex-shrink: 0;
    color: #fff;
  }

  .method-GET    { background: var(--get); }
  .method-POST   { background: var(--post); }
  .method-PUT    { background: var(--put); color: #2d3436; }
  .method-DELETE  { background: var(--delete); }
  .method-PATCH  { background: var(--patch); }

  .card-body { flex: 1; min-width: 0; }

  .card-id {
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-path {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-top: 0.15rem;
  }

  .card-path .param { color: var(--accent); }

  .card-file {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-top: 0.2rem;
    opacity: 0.7;
  }

  .status-pill {
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 0.15rem 0.45rem;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .pill-synced  { background: #0d2e24; color: var(--synced); }
  .pill-missing { background: #2d1b1b; color: var(--missing); }
  .pill-extra   { background: #2d2a1b; color: var(--extra); }

  .card-type {
    font-size: 0.65rem;
    color: var(--text-dim);
    background: var(--bg);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .filter-bar {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 2rem;
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-btn {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.3rem 0.7rem;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }

  .filter-btn:hover { border-color: #3a3f4f; color: var(--text); }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .separator {
    width: 1px;
    height: 20px;
    background: var(--border);
    margin: 0 0.25rem;
    align-self: center;
  }

  .empty {
    text-align: center;
    padding: 3rem;
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  #error {
    max-width: 960px;
    margin: 2rem auto;
    padding: 1rem 2rem;
    background: #2d1b1b;
    border: 1px solid #5c2626;
    border-radius: 8px;
    color: #f87171;
    display: none;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 0.35rem;
    vertical-align: middle;
  }

  .pr-section {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .pr-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: 10px;
    padding: 0.85rem 1.25rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .pr-card .pr-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
  }

  .pr-card .pr-body { flex: 1; }

  .pr-card .pr-title {
    font-weight: 600;
    font-size: 0.85rem;
  }

  .pr-card .pr-meta {
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-top: 0.15rem;
  }

  .pr-card .pr-meta a { color: var(--accent); text-decoration: none; }
  .pr-card .pr-meta a:hover { text-decoration: underline; }

  .pr-label {
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 0.15rem 0.45rem;
    border-radius: 3px;
    background: #1e1a3a;
    color: var(--accent);
  }

  .section-label {
    max-width: 960px;
    margin: 1rem auto 0.5rem;
    padding: 0 2rem;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1><span class="icon">&#9670;</span> Intent Board</h1>
    <div class="meta">
      <span id="version"></span>
      <span id="feature-count"></span>
      <span id="data-source"></span>
    </div>
  </div>
  <div class="header-actions">
    <button class="refresh-btn" id="refresh-btn" title="Refresh from GitHub">Refresh</button>
    <button class="settings-btn" id="settings-toggle">Settings</button>
  </div>
</div>

<div class="settings-panel" id="settings-panel">
  <div class="settings-inner">
    <h3>GitHub Connection</h3>
    <div class="setting-row">
      <label>Repo</label>
      <input type="text" id="cfg-repo" placeholder="owner/repo" />
    </div>
    <div class="setting-row">
      <label>Branch</label>
      <input type="text" id="cfg-branch" placeholder="main" />
    </div>
    <div class="setting-row">
      <label>Token</label>
      <input type="password" id="cfg-token" placeholder="ghp_... (needs repo + workflow scopes)" />
    </div>
    <div class="setting-row">
      <label></label>
      <button class="save-btn" id="cfg-save">Save & Reload</button>
      <span class="saved-indicator" id="cfg-saved">Saved</span>
    </div>
    <div class="setting-hint">
      Token needs <code>repo</code> and <code>workflow</code> scopes. Stored in localStorage only.
    </div>
  </div>
</div>

<div class="source-indicator" id="source-indicator"></div>
<div class="sync-banner" id="sync-banner"></div>
<div class="pr-section" id="pr-section"></div>
<div class="stats" id="stats"></div>
<div class="filter-bar" id="filters"></div>
<div class="board" id="board"></div>
<div id="error"></div>

<script>
const STORAGE_KEY = 'intent-board-config';

function loadConfig() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
  catch { return {}; }
}

function saveConfig(cfg) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
}

function ghHeaders(token) {
  return {
    'Authorization': `Bearer ${token}`,
    'Accept': 'application/vnd.github+json',
    'If-None-Match': '',  // Bypass GitHub API cache
  };
}

// --- GitHub API helpers ---

async function fetchFileContent(repo, branch, token, path) {
  const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
  const res = await fetch(url, { headers: ghHeaders(token) });
  if (!res.ok) throw new Error(`GitHub API ${res.status}: ${path}`);
  const data = await res.json();
  return atob(data.content);
}

async function fetchOpenPRs(repo, token) {
  const url = `https://api.github.com/repos/${repo}/pulls?state=open&labels=intent-generated&per_page=10`;
  const res = await fetch(url, { headers: ghHeaders(token) });
  if (!res.ok) return [];
  return res.json();
}

async function getLatestRun(repo, token) {
  const url = `https://api.github.com/repos/${repo}/actions/workflows/intent-check.yml/runs?per_page=1`;
  const res = await fetch(url, { headers: ghHeaders(token) });
  if (!res.ok) return null;
  const data = await res.json();
  return data.workflow_runs?.[0] || null;
}

async function triggerWorkflow(cfg) {
  const url = `https://api.github.com/repos/${cfg.repo}/actions/workflows/intent-check.yml/dispatches`;
  const res = await fetch(url, {
    method: 'POST',
    headers: ghHeaders(cfg.token),
    body: JSON.stringify({ ref: cfg.branch, inputs: { propose_pr: 'true' } }),
  });
  if (res.status === 204) return true;
  const body = await res.json().catch(() => ({}));
  throw new Error(body.message || `GitHub API returned ${res.status}`);
}

// --- Settings panel ---

const settingsToggle = document.getElementById('settings-toggle');
const settingsPanel = document.getElementById('settings-panel');
const cfgRepo = document.getElementById('cfg-repo');
const cfgBranch = document.getElementById('cfg-branch');
const cfgToken = document.getElementById('cfg-token');
const cfgSave = document.getElementById('cfg-save');
const cfgSaved = document.getElementById('cfg-saved');

const config = loadConfig();
cfgRepo.value = config.repo || '';
cfgBranch.value = config.branch || 'main';
cfgToken.value = config.token || '';

settingsToggle.addEventListener('click', () => settingsPanel.classList.toggle('visible'));

cfgSave.addEventListener('click', () => {
  saveConfig({
    repo: cfgRepo.value.trim(),
    branch: cfgBranch.value.trim() || 'main',
    token: cfgToken.value.trim(),
  });
  cfgSaved.classList.add('show');
  setTimeout(() => cfgSaved.classList.remove('show'), 2000);
  loadBoard();
});

document.getElementById('refresh-btn').addEventListener('click', () => loadBoard());

// --- Main board rendering ---

async function loadBoard() {
  const errorEl = document.getElementById('error');
  const bannerEl = document.getElementById('sync-banner');
  const statsEl = document.getElementById('stats');
  const filtersEl = document.getElementById('filters');
  const boardEl = document.getElementById('board');
  const sourceEl = document.getElementById('source-indicator');
  const prSectionEl = document.getElementById('pr-section');

  // Clear previous state
  errorEl.style.display = 'none';
  bannerEl.innerHTML = '';
  statsEl.innerHTML = '';
  filtersEl.innerHTML = '';
  boardEl.innerHTML = '';
  sourceEl.innerHTML = '';
  prSectionEl.innerHTML = '';

  const cfg = loadConfig();
  const useGitHub = cfg.repo && cfg.token;

  let intent, presentIds, missingIds, extraFeatures, implementedIn, presentFeatures, missingFeaturesList, openPRs = [];

  if (useGitHub) {
    // Show loading state
    bannerEl.innerHTML = '<div class="sync-banner-inner loading"><span class="sync-dot"></span> <span class="spinner"></span> Loading from GitHub...</div>';
    sourceEl.innerHTML = `Reading from <a href="https://github.com/${cfg.repo}/tree/${cfg.branch}" target="_blank">${cfg.repo}@${cfg.branch}</a>`;

    try {
      // Fetch intent.json from main branch
      const intentRaw = await fetchFileContent(cfg.repo, cfg.branch, cfg.token, 'intent.json');
      intent = JSON.parse(intentRaw);

      // Fetch report from gh-pages branch (published by CI)
      let report = null;
      try {
        const reportRaw = await fetchFileContent(cfg.repo, 'gh-pages', cfg.token, 'intent-report.json');
        report = JSON.parse(reportRaw);
      } catch(e) {
        // gh-pages branch may not exist yet
      }

      presentIds = new Set();
      missingIds = new Set();
      extraFeatures = [];
      implementedIn = {};

      if (report) {
        for (const f of (report.presentFeatures || [])) {
          presentIds.add(f.id);
          if (f.implementedIn) implementedIn[f.id] = f.implementedIn;
        }
        for (const f of (report.missingFeatures || [])) missingIds.add(f.id);
        extraFeatures = report.extraFeatures || [];

        // Show report timestamp
        if (report.timestamp) {
          const t = new Date(report.timestamp);
          sourceEl.innerHTML += ` &mdash; report from ${t.toLocaleString()}`;
        }
      }

      // Fetch open intent-generated PRs
      openPRs = await fetchOpenPRs(cfg.repo, cfg.token);

    } catch(e) {
      bannerEl.innerHTML = '';
      errorEl.textContent = `GitHub: ${e.message}`;
      errorEl.style.display = 'block';
      return;
    }
  } else {
    // Fallback: local files
    sourceEl.innerHTML = 'Reading from local files. <a href="#" id="open-settings">Configure GitHub</a> for live sync.';
    document.getElementById('open-settings')?.addEventListener('click', (e) => {
      e.preventDefault();
      settingsPanel.classList.add('visible');
    });

    try {
      const res = await fetch('intent.json');
      if (!res.ok) throw new Error(`Failed to load intent.json (${res.status})`);
      intent = await res.json();
    } catch(e) {
      errorEl.textContent = e.message;
      errorEl.style.display = 'block';
      return;
    }

    let report = null;
    try {
      const res = await fetch('intent-report.json');
      if (res.ok) report = await res.json();
    } catch(e) {}

    presentIds = new Set();
    missingIds = new Set();
    extraFeatures = [];
    implementedIn = {};

    if (report) {
      for (const f of (report.presentFeatures || [])) {
        presentIds.add(f.id);
        if (f.implementedIn) implementedIn[f.id] = f.implementedIn;
      }
      for (const f of (report.missingFeatures || [])) missingIds.add(f.id);
      extraFeatures = report.extraFeatures || [];
    }
  }

  const features = intent.features || [];
  const hasReport = useGitHub || presentIds.size > 0 || missingIds.size > 0;

  // Meta
  document.getElementById('version').textContent = `v${intent.version}`;
  document.getElementById('feature-count').textContent = `${features.length} features`;
  document.getElementById('data-source').textContent = useGitHub ? 'live' : 'local';

  // Sync banner
  bannerEl.innerHTML = '';
  const numMissing = missingIds.size;
  const numExtra = extraFeatures.length;
  const inSync = hasReport && numMissing === 0 && numExtra === 0;

  const inner = document.createElement('div');
  if (!hasReport) {
    inner.className = 'sync-banner-inner no-config';
    inner.innerHTML = '<span class="sync-dot" style="background:var(--text-dim)"></span> No sync data available';
  } else if (inSync) {
    inner.className = 'sync-banner-inner all-synced';
    inner.innerHTML = '<span class="sync-dot"></span> All features are in sync';
  } else {
    inner.className = 'sync-banner-inner out-of-sync';
    const parts = [];
    if (numMissing > 0) parts.push(`${numMissing} missing`);
    if (numExtra > 0) parts.push(`${numExtra} extra`);
    inner.innerHTML = `
      <span class="sync-dot"></span> Out of sync: ${parts.join(', ')}
      <span class="sync-actions">
        <span class="trigger-status" id="trigger-status"></span>
        <button class="trigger-btn" id="trigger-btn">Fix with AI</button>
      </span>`;
  }
  bannerEl.appendChild(inner);

  // Wire up trigger button
  const triggerBtn = document.getElementById('trigger-btn');
  const triggerStatus = document.getElementById('trigger-status');

  if (triggerBtn && useGitHub) {
    triggerBtn.addEventListener('click', async () => {
      triggerBtn.disabled = true;
      triggerBtn.innerHTML = '<span class="spinner"></span>Triggering...';
      triggerStatus.textContent = '';
      try {
        await triggerWorkflow(cfg);
        triggerBtn.textContent = 'Triggered!';
        triggerBtn.classList.add('running');
        triggerStatus.innerHTML = 'Waiting for run...';

        let attempts = 0;
        const poll = setInterval(async () => {
          attempts++;
          try {
            const run = await getLatestRun(cfg.repo, cfg.token);
            if (run && run.status !== 'completed' && new Date(run.created_at) > new Date(Date.now() - 60000)) {
              clearInterval(poll);
              triggerStatus.innerHTML = `<span class="spinner"></span> Running... <a href="${run.html_url}" target="_blank">View</a>`;
              const pollComplete = setInterval(async () => {
                const updated = await getLatestRun(cfg.repo, cfg.token);
                if (updated && updated.status === 'completed') {
                  clearInterval(pollComplete);
                  const icon = updated.conclusion === 'success' ? '&#10003;' : '&#10007;';
                  const color = updated.conclusion === 'success' ? 'var(--synced)' : 'var(--missing)';
                  triggerStatus.innerHTML = `<span style="color:${color}">${icon}</span> ${updated.conclusion} &mdash; <a href="${updated.html_url}" target="_blank">View run</a>`;
                  triggerBtn.textContent = 'Refresh board';
                  triggerBtn.disabled = false;
                  triggerBtn.classList.remove('running');
                  triggerBtn.onclick = () => loadBoard();
                }
              }, 5000);
            }
          } catch(e) {}
          if (attempts > 12) {
            clearInterval(poll);
            triggerStatus.innerHTML = `Check <a href="https://github.com/${cfg.repo}/actions" target="_blank">Actions</a>`;
            triggerBtn.textContent = 'Refresh board';
            triggerBtn.disabled = false;
            triggerBtn.classList.remove('running');
            triggerBtn.onclick = () => loadBoard();
          }
        }, 3000);
      } catch(e) {
        triggerStatus.textContent = `Error: ${e.message}`;
        triggerBtn.textContent = 'Fix with AI';
        triggerBtn.disabled = false;
      }
    });
  } else if (triggerBtn && !useGitHub) {
    triggerBtn.addEventListener('click', () => {
      settingsPanel.classList.add('visible');
    });
  }

  // Open PRs section
  if (openPRs.length > 0) {
    const label = document.createElement('div');
    label.className = 'section-label';
    label.textContent = 'Pending Fix PRs';
    prSectionEl.appendChild(label);

    for (const pr of openPRs) {
      const card = document.createElement('div');
      card.className = 'pr-card';
      card.innerHTML = `
        <span class="pr-icon">&#9741;</span>
        <div class="pr-body">
          <div class="pr-title">${pr.title} <span class="pr-label">draft</span></div>
          <div class="pr-meta">#${pr.number} opened ${new Date(pr.created_at).toLocaleDateString()} &mdash; <a href="${pr.html_url}" target="_blank">View on GitHub</a></div>
        </div>
      `;
      prSectionEl.appendChild(card);
    }
  }

  // Stats
  if (hasReport) {
    const statEntries = [
      { label: 'Total', value: features.length, cls: '' },
      { label: 'Synced', value: presentIds.size, cls: 'synced' },
      { label: 'Missing', value: missingIds.size, cls: 'missing' },
      { label: 'Extra', value: extraFeatures.length, cls: 'extra' },
    ];
    for (const s of statEntries) {
      const div = document.createElement('div');
      div.className = `stat ${s.cls}`;
      div.innerHTML = `<div class="number">${s.value}</div><div class="label">${s.label}</div>`;
      statsEl.appendChild(div);
    }
  } else {
    const methods = {};
    for (const f of features) methods[f.method] = (methods[f.method] || 0) + 1;
    for (const s of [{ label: 'Total', value: features.length }, ...Object.entries(methods).map(([m, c]) => ({ label: m, value: c }))]) {
      const div = document.createElement('div');
      div.className = 'stat';
      div.innerHTML = `<div class="number">${s.value}</div><div class="label">${s.label}</div>`;
      statsEl.appendChild(div);
    }
  }

  // Build cards
  const allCards = features.map(f => {
    let status = 'unknown';
    if (hasReport) status = presentIds.has(f.id) ? 'synced' : 'missing';
    return { ...f, status, file: implementedIn[f.id] || null };
  });
  for (const f of extraFeatures) {
    allCards.push({ ...f, status: 'extra', file: f.implementedIn || null });
  }

  // Filters
  let activeMethodFilter = 'ALL';
  let activeStatusFilter = 'ALL';
  const methods = {};
  for (const f of features) methods[f.method] = (methods[f.method] || 0) + 1;
  const allMethods = ['ALL', ...Object.keys(methods)];
  const statusFilters = hasReport ? ['ALL', 'SYNCED', 'MISSING', 'EXTRA'] : [];

  function renderCards() {
    boardEl.innerHTML = '';
    let filtered = allCards;
    if (activeMethodFilter !== 'ALL') filtered = filtered.filter(f => f.method === activeMethodFilter);
    if (activeStatusFilter !== 'ALL') filtered = filtered.filter(f => f.status === activeStatusFilter.toLowerCase());

    if (filtered.length === 0) {
      boardEl.innerHTML = '<div class="empty">No features match this filter.</div>';
      return;
    }

    const order = { missing: 0, extra: 1, synced: 2, unknown: 3 };
    filtered.sort((a, b) => (order[a.status] ?? 3) - (order[b.status] ?? 3));

    for (const f of filtered) {
      const card = document.createElement('div');
      card.className = `card status-${f.status}`;
      const pathHtml = f.path.replace(/:(\w+)/g, '<span class="param">:$1</span>');
      const pillClass = f.status === 'synced' ? 'pill-synced' : f.status === 'missing' ? 'pill-missing' : f.status === 'extra' ? 'pill-extra' : '';
      const pillLabel = f.status === 'synced' ? 'synced' : f.status === 'missing' ? 'missing' : f.status === 'extra' ? 'extra' : '';
      const statusHtml = hasReport && pillLabel ? `<span class="status-pill ${pillClass}">${pillLabel}</span>` : '';
      const fileHtml = f.file ? `<div class="card-file">${f.file}</div>` : '';
      card.innerHTML = `
        <span class="method-badge method-${f.method}">${f.method}</span>
        <div class="card-body">
          <div class="card-id">${f.id} ${statusHtml}</div>
          <div class="card-path">${pathHtml}</div>
          ${fileHtml}
        </div>
        <span class="card-type">${f.type || 'http-route'}</span>
      `;
      boardEl.appendChild(card);
    }
  }

  for (const m of allMethods) {
    const btn = document.createElement('button');
    btn.className = 'filter-btn method-filter' + (m === 'ALL' ? ' active' : '');
    btn.textContent = m;
    btn.addEventListener('click', () => {
      activeMethodFilter = m;
      filtersEl.querySelectorAll('.method-filter').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderCards();
    });
    filtersEl.appendChild(btn);
  }

  if (statusFilters.length > 0) {
    const sep = document.createElement('div');
    sep.className = 'separator';
    filtersEl.appendChild(sep);
    for (const s of statusFilters) {
      const btn = document.createElement('button');
      btn.className = 'filter-btn status-filter' + (s === 'ALL' ? ' active' : '');
      btn.textContent = s === 'ALL' ? 'ALL STATUS' : s;
      btn.addEventListener('click', () => {
        activeStatusFilter = s;
        filtersEl.querySelectorAll('.status-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderCards();
      });
      filtersEl.appendChild(btn);
    }
  }

  renderCards();
}

// Initial load
loadBoard();
</script>
</body>
</html>
