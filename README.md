# diffintel

A structural diff explainer for pull requests. Parses changed files with Tree-sitter, detects structural changes (functions, classes, imports, variables), and optionally uses an LLM to generate a plain-language explanation with impact assessment and risk analysis. Outputs a self-contained HTML report and a markdown summary suitable for PR comments.

Works without an API key — you get structural analysis, diffs, and stats. Add an API key for AI-powered explanations, impact statements, and risk assessment.

## Supported languages

JavaScript, TypeScript, Python, Go, Rust, Java, C, C++, Ruby, PHP, C#. Files in other languages still appear in the report with raw diffs.

## Install

```bash
npm install -g diffintel
```

## Usage

```bash
diffintel explain --base main --out report.html
```

With AI explanations:

```bash
export ANTHROPIC_API_KEY=sk-ant-...
diffintel explain --base main
```

| Flag | Default | Description |
|---|---|---|
| `--base <ref>` | `origin/main` | Base git ref |
| `--head <ref>` | `HEAD` | Head git ref |
| `--out <file>` | `explain-report.html` | Output HTML report path |
| `--summary <file>` | `<out>.md` | Output markdown summary path |

## What the report includes

- **Impact** — stakeholder-level statements about what the change means (security, reliability, etc.)
- **Fixes** — things this change repairs or restores
- **Risks** — genuine new concerns, graded low/medium/high
- **Structural changes** — functions, classes, imports added/removed/modified per file
- **Per-file explanations** — plain-language summary of each changed file
- **Collapsible diffs** — syntax-highlighted, truncated for large changes

## GitHub Action

Posts a summary comment on the PR and uploads the full report as an artifact:

```yaml
name: PR Explain
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  explain:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install -g diffintel
      - name: Generate report
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: diffintel explain --base origin/${{ github.base_ref }}
      - uses: actions/upload-artifact@v4
        with:
          name: explain-report
          path: explain-report.html
      - name: Post PR comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_TAG="<!-- diffintel-report -->"
          BODY="$(cat explain-report.md)"
          BODY="${BODY//_Generated by diffintel_/_Generated by diffintel · [Full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_}"
          FULL_BODY="${COMMENT_TAG}
          ${BODY}"
          EXISTING=$(gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --jq ".[] | select(.body | startswith(\"${COMMENT_TAG}\")) | .id" | head -1)
          if [ -n "$EXISTING" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING}" -X PATCH -f body="${FULL_BODY}"
          else
            gh pr comment "${{ github.event.pull_request.number }}" --body "${FULL_BODY}"
          fi
```

The comment updates on each push — no duplicates.

## Development

```bash
npm install
npm test
npx tsx src/cli.ts explain --base HEAD~3
```
