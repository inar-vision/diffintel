name: Intent Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      propose_pr:
        description: 'Create a fix PR if intent is out of sync'
        type: boolean
        default: true

env:
  INTENT_PROPOSE_PR: ${{ inputs.propose_pr || 'true' }}

permissions:
  contents: write
  pull-requests: write

jobs:
  check-intent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install

      - name: Check intent coverage
        id: check
        continue-on-error: true
        run: node check-intent.js --out intent-report.json

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: intent-report
          path: intent-report.json

      - name: Post summary
        if: always()
        run: |
          echo "## Intent Coverage Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>Full JSON report</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          cat intent-report.json >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Publish report to gh-pages
        if: always()
        run: |
          # Use a separate directory to avoid corrupting the main workspace
          REPORT_DIR=$(mktemp -d)
          cp intent-report.json "$REPORT_DIR/intent-report.json"

          cd "$REPORT_DIR"
          git init -b gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add intent-report.json
          git commit -m "Update intent report [skip ci]"
          git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          git push origin gh-pages --force

          # Return to the original workspace
          cd "$GITHUB_WORKSPACE"
          rm -rf "$REPORT_DIR"

      - name: Propose and apply fixes
        id: apply
        if: steps.check.outcome == 'failure' && env.INTENT_PROPOSE_PR == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set +e
          node propose-fix.js --apply intent-report.json
          EXIT_CODE=$?
          set -e
          if [ "$EXIT_CODE" -eq 0 ] && [ -f apply-result.json ]; then
            echo "applied=true" >> "$GITHUB_OUTPUT"
            echo "Apply succeeded:"
            cat apply-result.json
          else
            echo "applied=false" >> "$GITHUB_OUTPUT"
            echo "Apply exited with code $EXIT_CODE, falling back to report-only"
          fi

      - name: Create fix branch and PR
        if: steps.apply.outputs.applied == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="intent-fix/$(date +%s)"
          git checkout -b "$BRANCH"

          CHANGED_FILES=$(node -e "const r=require('./apply-result.json'); r.changedFiles.forEach(f => console.log(f))")
          MISSING=$(node -e "const r=require('./apply-result.json'); console.log(r.missingFeatures.join(', '))")

          for f in $CHANGED_FILES; do
            git add "$f"
          done

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "feat: add missing intent routes

          Auto-generated by intent reconciliation.
          Missing features: $MISSING"

          git push origin "$BRANCH"

          gh label create intent-generated --color "D4C5F9" --description "Auto-generated by intent reconciliation" --force

          CHANGED_LIST=$(echo "$CHANGED_FILES" | sed 's/^/- `/' | sed 's/$/`/')
          MISSING_LIST=$(node -e "const r=require('./apply-result.json'); r.missingFeatures.forEach(f => console.log('- ' + f))")

          gh pr create --draft --label intent-generated \
            --title "feat: implement missing intent features" \
            --body "$(cat <<'PREOF'
          > **Warning**: This PR was auto-generated by the intent reconciliation system using AI. It requires careful human review before merging.

          ## Missing features addressed
          PREOF
          )
          ${MISSING_LIST}

          ## Changed files
          ${CHANGED_LIST}

          ## Review checklist
          - [ ] Routes match intent specification
          - [ ] Handler logic is correct
          - [ ] No existing functionality was broken
          - [ ] Tests pass
          - [ ] Code style matches project conventions"

      - name: Fail if intent check failed
        if: steps.check.outcome == 'failure' && steps.apply.outputs.applied != 'true'
        run: |
          echo "Intent check found missing or extra features"
          exit 1
