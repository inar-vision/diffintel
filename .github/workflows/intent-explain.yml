name: PR Explain

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  explain:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci
      - run: npm run build

      - name: Generate explain report
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node dist/cli.js explain --base origin/${{ github.base_ref }} --out explain-report.html --summary explain-summary.md

      - uses: actions/upload-artifact@v4
        with:
          name: explain-report
          path: explain-report.html

      - name: Post or update PR comment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACT_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          COMMENT_TAG="<!-- diffintel-report -->"
          BODY="$(cat explain-summary.md)"
          # Append artifact link to footer
          BODY="${BODY//_Generated by diffintel_/_Generated by diffintel Â· [Full report](${ARTIFACT_URL})_}"
          FULL_BODY="${COMMENT_TAG}
          ${BODY}"

          # Find existing diffintel comment
          EXISTING=$(gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --jq ".[] | select(.body | startswith(\"${COMMENT_TAG}\")) | .id" | head -1)

          if [ -n "$EXISTING" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING}" -X PATCH -f body="${FULL_BODY}"
          else
            gh pr comment "${{ github.event.pull_request.number }}" --body "${FULL_BODY}"
          fi
